 Push notifications are a powerful and free browser feature that is often overlooked by products due to the complexity of service workers and the backend infra required to send notifications.

 In this post we will discuss how to implement you own push notification service that will scale as you grow.

 We will use service workers and AWS lambda functions to send notifications to a site saved as a PWA on the users phone

 ## Demo

 Here is a demo of what we are building:

 ## Implementation

 For this service we are using AWS lambda and deploying via the serverless framework. You can deploy this type of application in any kind of backend but I prefer the pay per execution model of the AWS serverless offerings.

 ### Frontend setup

 Our frontend will be a debugger to test our push notification service.

 <!-- doc-gen CODE src="https://github.com/DavidWells/saaslayer/blob/master/services/push-service/debugger/index.html" -->
 <pre class="language-html" style="background-color:#fff;--shiki-dark-bg:transparent;color:#24292e;--shiki-dark:#F8F8F2" tabindex="0"><code class="language-html"><span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">&lt;!</span><span style="color:#22863A;--shiki-dark:#FF79C6">DOCTYPE</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> html</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">&lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">html</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> lang</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">en</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">  &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">head</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">    &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">meta</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> http-equiv</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">Content-Type</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> content</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">text/html; charset=UTF-8</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">    &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">meta</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> name</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">viewport</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> content</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">width=device-width, initial-scale=1</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">    &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">title</span><span style="color:#24292E;--shiki-dark:#F8F8F2">>Web Push Demo&lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">title</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">    &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">meta</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> name</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">description</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> content</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">Web Push Demo</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">    &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">link</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> rel</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">manifest</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> href</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">/manifest.json</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">    &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">link</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> rel</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">stylesheet</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> href</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">./assets/paper.min.css</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">    &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">link</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> rel</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">stylesheet</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> href</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">./assets/style.css</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">  &lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">head</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">  &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">body</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">    &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">div</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> class</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">background</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#24292E;--shiki-dark:#F8F8F2">>&lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">div</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">    &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">div</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> class</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">paper content</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">      &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">h2</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> class</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">heading</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">        &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">span</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">          Web Push Debugger</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">        &lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">span</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">        &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">div</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> class</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">status</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">          &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">p</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">            Push supported: &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">u</span><span style="color:#24292E;--shiki-dark:#F8F8F2">>&lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">strong</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> id</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">push-notification-supported</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#24292E;--shiki-dark:#F8F8F2">>true&lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">strong</span><span style="color:#24292E;--shiki-dark:#F8F8F2">>&lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">u</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">          &lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">p</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">          &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">p</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">            User consent: &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">u</span><span style="color:#24292E;--shiki-dark:#F8F8F2">>&lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">strong</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> id</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">push-notification-consent</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#24292E;--shiki-dark:#F8F8F2">>granted&lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">strong</span><span style="color:#24292E;--shiki-dark:#F8F8F2">>&lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">u</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">          &lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">p</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">        &lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">div</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">      &lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">h2</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">      &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">div</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> class</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#032F62;--shiki-dark:#F1FA8C">debugger</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">        &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">div</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> class</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#032F62;--shiki-dark:#F1FA8C">trigger</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">            &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">div</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">              &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">h4</span><span style="color:#24292E;--shiki-dark:#F8F8F2">>step 1: Ask user consent to show notifications&lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">h4</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">              &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">button</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> id</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">ask-user-permission-button</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#24292E;--shiki-dark:#F8F8F2">>Ask user permission&lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">button</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">            &lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">div</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">            &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">div</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">              &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">h4</span><span style="color:#24292E;--shiki-dark:#F8F8F2">>step 2: Subscribe to push notification&lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">h4</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">              &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">p</span><span style="color:#24292E;--shiki-dark:#F8F8F2">>this will create an endpoint that has to be sent to the push server&lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">p</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">              &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">button</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> id</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">create-notification-subscription-button</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#24292E;--shiki-dark:#F8F8F2">>Create notification subscription&lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">button</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">            &lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">div</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">            &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">div</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">              &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">h4</span><span style="color:#24292E;--shiki-dark:#F8F8F2">>step 3: Send notification&lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">h4</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">              &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">p</span><span style="color:#24292E;--shiki-dark:#F8F8F2">>Fire push notification from server&lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">p</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">              &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">form</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> id</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">send-push-form</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">                &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">div</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">                  &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">input</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> name</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">title</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> value</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">Message Title</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> placeholder</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">Message Title</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> type</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">text</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> required</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">""</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">                &lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">div</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">                &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">div</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">                  &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">input</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> name</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">body</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> value</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">Message Body</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> placeholder</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">Message Body</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> type</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">text</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> required</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">""</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">                &lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">div</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">                &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">div</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">                  &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">input</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> name</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">data</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> value</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#032F62;--shiki-dark:#F1FA8C">{ "foo": "bar" }</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic">  placeholder</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">Custom Data</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> type</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">text</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">                &lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">div</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">                &lt;!-- &lt;div></span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">                  &lt;input name="delay" placeholder="Number of seconds to delay" type="text"></span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">                &lt;/div> --></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">                &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">textarea</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> name</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">subs</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> id</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">user-susbription</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#24292E;--shiki-dark:#F8F8F2">>&lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">textarea</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">                &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">input</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> id</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">send-push-notification-button</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> type</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">submit</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> value</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">Send a push notification 🚀</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">              &lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">form</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">            &lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">div</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">        &lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">div</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">        &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">div</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> class</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#032F62;--shiki-dark:#F1FA8C">response</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">          &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">h3</span><span style="color:#24292E;--shiki-dark:#F8F8F2">>Web Push Custom Data:&lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">h3</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">          &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">textarea</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> </span></span>
 <span class="line"><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic">            placeholder</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">Push notification response data... This is shown when notification is clicked</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> </span></span>
 <span class="line"><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic">            id</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">web-notification</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic">            class</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">web-notification</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span></span>
 <span class="line"><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic">            disabled</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">          >&lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">textarea</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">        &lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">div</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">      &lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">div</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">  </span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">    &lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">div</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">    &lt;</span><span style="color:#22863A;--shiki-dark:#FF79C6">script</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> src</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">./assets/app.js</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#6F42C1;--shiki-dark:#50FA7B;font-style:inherit;--shiki-dark-font-style:italic"> type</span><span style="color:#24292E;--shiki-dark:#FF79C6">=</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">module</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#24292E;--shiki-dark:#F8F8F2">>&lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">script</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">  &lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">body</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">&lt;/</span><span style="color:#22863A;--shiki-dark:#FF79C6">html</span><span style="color:#24292E;--shiki-dark:#F8F8F2">></span></span></code></pre>
 <!-- end-doc-gen -->

 Backend setup

 <!-- doc-gen CODE src="https://github.com/DavidWells/saaslayer/blob/master/services/push-service/handler.js" -->
 <pre class="language-js" style="background-color:#fff;--shiki-dark-bg:transparent;color:#24292e;--shiki-dark:#F8F8F2" tabindex="0"><code class="language-js"><span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">const</span><span style="color:#005CC5;--shiki-dark:#F8F8F2"> fs</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> =</span><span style="color:#6F42C1;--shiki-dark:#50FA7B"> require</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#032F62;--shiki-dark:#F1FA8C">fs</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#24292E;--shiki-dark:#F8F8F2">)</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">const</span><span style="color:#005CC5;--shiki-dark:#F8F8F2"> querystring</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> =</span><span style="color:#6F42C1;--shiki-dark:#50FA7B"> require</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#032F62;--shiki-dark:#F1FA8C">querystring</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#24292E;--shiki-dark:#F8F8F2">)</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">const</span><span style="color:#005CC5;--shiki-dark:#F8F8F2"> webPush</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> =</span><span style="color:#6F42C1;--shiki-dark:#50FA7B"> require</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#032F62;--shiki-dark:#F1FA8C">web-push</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#24292E;--shiki-dark:#F8F8F2">);</span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">if</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> (</span><span style="color:#D73A49;--shiki-dark:#FF79C6">!</span><span style="color:#24292E;--shiki-dark:#F8F8F2">process.env.</span><span style="color:#005CC5;--shiki-dark:#BD93F9">VAPID_PUBLIC_KEY</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> ||</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> !</span><span style="color:#24292E;--shiki-dark:#F8F8F2">process.env.</span><span style="color:#005CC5;--shiki-dark:#BD93F9">VAPID_PRIVATE_KEY</span><span style="color:#24292E;--shiki-dark:#F8F8F2">) {</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">  console.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">log</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#032F62;--shiki-dark:#F1FA8C">You must set the VAPID_PUBLIC_KEY and VAPID_PRIVATE_KEY </span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> +</span></span>
 <span class="line"><span style="color:#032F62;--shiki-dark:#E9F284">    "</span><span style="color:#032F62;--shiki-dark:#F1FA8C">environment variables. You can use the following ones:</span><span style="color:#032F62;--shiki-dark:#E9F284">"</span><span style="color:#24292E;--shiki-dark:#F8F8F2">);</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">  console.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">log</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(webPush.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">generateVAPIDKeys</span><span style="color:#24292E;--shiki-dark:#F8F8F2">());</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">}</span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">webPush.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">setVapidDetails</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">  process.env.</span><span style="color:#005CC5;--shiki-dark:#BD93F9">VAPID_DOMAIN</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> ||</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> process.env.</span><span style="color:#005CC5;--shiki-dark:#BD93F9">VAPID_CONTACT</span><span style="color:#24292E;--shiki-dark:#F8F8F2">,</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">  process.env.</span><span style="color:#005CC5;--shiki-dark:#BD93F9">VAPID_PUBLIC_KEY</span><span style="color:#24292E;--shiki-dark:#F8F8F2">,</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">  process.env.</span><span style="color:#005CC5;--shiki-dark:#BD93F9">VAPID_PRIVATE_KEY</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">);</span></span>
 <span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">function</span><span style="color:#6F42C1;--shiki-dark:#50FA7B"> response</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#E36209;--shiki-dark:#FFB86C;font-style:inherit;--shiki-dark-font-style:italic">statusCode</span><span style="color:#24292E;--shiki-dark:#F8F8F2">, </span><span style="color:#E36209;--shiki-dark:#FFB86C;font-style:inherit;--shiki-dark-font-style:italic">body</span><span style="color:#24292E;--shiki-dark:#F8F8F2">, </span><span style="color:#E36209;--shiki-dark:#FFB86C;font-style:inherit;--shiki-dark-font-style:italic">file</span><span style="color:#24292E;--shiki-dark:#F8F8F2">) {</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">  let</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> payload </span><span style="color:#D73A49;--shiki-dark:#FF79C6">=</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> {</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">    statusCode,</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">    // api gateway cors headers</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">    headers</span><span style="color:#24292E;--shiki-dark:#FF79C6">:</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> {</span></span>
 <span class="line"><span style="color:#032F62;--shiki-dark:#E9F284">      '</span><span style="color:#032F62;--shiki-dark:#F1FA8C">Access-Control-Allow-Origin</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#24292E;--shiki-dark:#FF79C6">:</span><span style="color:#032F62;--shiki-dark:#E9F284"> '</span><span style="color:#032F62;--shiki-dark:#F1FA8C">*</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#24292E;--shiki-dark:#F8F8F2">,</span></span>
 <span class="line"><span style="color:#032F62;--shiki-dark:#E9F284">      '</span><span style="color:#032F62;--shiki-dark:#F1FA8C">Access-Control-Allow-Credentials</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#24292E;--shiki-dark:#FF79C6">:</span><span style="color:#005CC5;--shiki-dark:#BD93F9"> true</span><span style="color:#24292E;--shiki-dark:#F8F8F2">,</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">    },</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">    body</span><span style="color:#24292E;--shiki-dark:#FF79C6">:</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> typeof</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> (body) </span><span style="color:#D73A49;--shiki-dark:#FF79C6">===</span><span style="color:#032F62;--shiki-dark:#E9F284"> '</span><span style="color:#032F62;--shiki-dark:#F1FA8C">string</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> ?</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> body </span><span style="color:#D73A49;--shiki-dark:#FF79C6">:</span><span style="color:#005CC5;--shiki-dark:#BD93F9"> JSON</span><span style="color:#24292E;--shiki-dark:#F8F8F2">.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">stringify</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(body, </span><span style="color:#005CC5;--shiki-dark:#BD93F9">null</span><span style="color:#24292E;--shiki-dark:#F8F8F2">, </span><span style="color:#005CC5;--shiki-dark:#BD93F9">2</span><span style="color:#24292E;--shiki-dark:#F8F8F2">)</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">  };</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">  console.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">log</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#032F62;--shiki-dark:#F1FA8C">RESPOND</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#24292E;--shiki-dark:#F8F8F2">, payload);</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">  return</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> payload;</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">}</span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#005CC5;--shiki-dark:#8BE9FD;font-style:inherit;--shiki-dark-font-style:italic">module</span><span style="color:#24292E;--shiki-dark:#F8F8F2">.</span><span style="color:#005CC5;--shiki-dark:#8BE9FD;font-style:inherit;--shiki-dark-font-style:italic">exports</span><span style="color:#24292E;--shiki-dark:#F8F8F2">.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">vapidPublicKey</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> =</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> async</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> () </span><span style="color:#D73A49;--shiki-dark:#FF79C6">=></span><span style="color:#24292E;--shiki-dark:#F8F8F2"> {</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">  return</span><span style="color:#6F42C1;--shiki-dark:#50FA7B"> response</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#005CC5;--shiki-dark:#BD93F9">200</span><span style="color:#24292E;--shiki-dark:#F8F8F2">, process.env.</span><span style="color:#005CC5;--shiki-dark:#BD93F9">VAPID_PUBLIC_KEY</span><span style="color:#24292E;--shiki-dark:#F8F8F2">);</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">};</span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">// module.exports.register = async (event, context) => {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   // Save the registered users subscriptions (event.body)</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   await addSubscription(JSON.parse(event.body));</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   return response(201, event);</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">// };</span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">// async function getSubscriptions() {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   const s = await s3.getObject({ Bucket: process.env.STATE_BUCKET, Key: 'subscriptions'}).promise();</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   return JSON.parse(s.Body.toString("utf-8"));</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">// }</span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">// async function addSubscription(subscription) {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   let subscriptions = await getSubscriptions();</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   console.log(subscriptions);</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   let uniq = {};</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   for (let i=0; i &lt; subscriptions.length; i++){</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     uniq[subscriptions[i].endpoint] = subscriptions[i];</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   }</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   uniq[subscription.endpoint] = subscription; // use latest for endpoint</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   await s3.putObject({</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     Bucket: process.env.STATE_BUCKET,</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     Key: 'subscriptions',</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     Body: JSON.stringify(Object.values(uniq)),</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     ContentType: 'application/json'</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   }).promise();</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">// }</span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">// TODO remove stale subscriptions </span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">function</span><span style="color:#6F42C1;--shiki-dark:#50FA7B"> send</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#E36209;--shiki-dark:#FFB86C;font-style:inherit;--shiki-dark-font-style:italic">subscriptions</span><span style="color:#24292E;--shiki-dark:#F8F8F2">, </span><span style="color:#E36209;--shiki-dark:#FFB86C;font-style:inherit;--shiki-dark-font-style:italic">payload</span><span style="color:#24292E;--shiki-dark:#F8F8F2">, </span><span style="color:#E36209;--shiki-dark:#FFB86C;font-style:inherit;--shiki-dark-font-style:italic">options</span><span style="color:#24292E;--shiki-dark:#F8F8F2">, </span><span style="color:#E36209;--shiki-dark:#FFB86C;font-style:inherit;--shiki-dark-font-style:italic">delay</span><span style="color:#24292E;--shiki-dark:#F8F8F2">) {</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">  console.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">log</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#032F62;--shiki-dark:#F1FA8C">send</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#24292E;--shiki-dark:#F8F8F2">, subscriptions, payload, options, delay);</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">  const</span><span style="color:#005CC5;--shiki-dark:#F8F8F2"> payload_string</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> =</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> typeof</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> (payload) </span><span style="color:#D73A49;--shiki-dark:#FF79C6">===</span><span style="color:#032F62;--shiki-dark:#E9F284"> '</span><span style="color:#032F62;--shiki-dark:#F1FA8C">string</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> ?</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> payload </span><span style="color:#D73A49;--shiki-dark:#FF79C6">:</span><span style="color:#005CC5;--shiki-dark:#BD93F9"> JSON</span><span style="color:#24292E;--shiki-dark:#F8F8F2">.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">stringify</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(payload)</span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">  return</span><span style="color:#D73A49;--shiki-dark:#FF79C6;font-weight:inherit;--shiki-dark-font-weight:bold"> new</span><span style="color:#005CC5;--shiki-dark:#8BE9FD;font-style:inherit;--shiki-dark-font-style:italic"> Promise</span><span style="color:#24292E;--shiki-dark:#F8F8F2">((</span><span style="color:#E36209;--shiki-dark:#FFB86C;font-style:inherit;--shiki-dark-font-style:italic">success</span><span style="color:#24292E;--shiki-dark:#F8F8F2">) </span><span style="color:#D73A49;--shiki-dark:#FF79C6">=></span><span style="color:#24292E;--shiki-dark:#F8F8F2"> {</span></span>
 <span class="line"><span style="color:#6F42C1;--shiki-dark:#50FA7B">    setTimeout</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(() </span><span style="color:#D73A49;--shiki-dark:#FF79C6">=></span><span style="color:#24292E;--shiki-dark:#F8F8F2"> {</span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#005CC5;--shiki-dark:#8BE9FD;font-style:inherit;--shiki-dark-font-style:italic">      Promise</span><span style="color:#24292E;--shiki-dark:#F8F8F2">.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">all</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(subscriptions.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">map</span><span style="color:#24292E;--shiki-dark:#F8F8F2">((</span><span style="color:#E36209;--shiki-dark:#FFB86C;font-style:inherit;--shiki-dark-font-style:italic">each_subscription</span><span style="color:#24292E;--shiki-dark:#F8F8F2">) </span><span style="color:#D73A49;--shiki-dark:#FF79C6">=></span><span style="color:#24292E;--shiki-dark:#F8F8F2"> {</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">        console.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">log</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#032F62;--shiki-dark:#F1FA8C">sending each_subscription</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#24292E;--shiki-dark:#F8F8F2">, each_subscription)</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">        console.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">log</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#032F62;--shiki-dark:#F1FA8C">Message</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#24292E;--shiki-dark:#F8F8F2">, payload_string)</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">        return</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> webPush.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">sendNotification</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(each_subscription, payload_string, options);</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">      }))</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">        .</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">then</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#D73A49;--shiki-dark:#FF79C6">function</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> () {</span></span>
 <span class="line"><span style="color:#6F42C1;--shiki-dark:#50FA7B">          success</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">response</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#005CC5;--shiki-dark:#BD93F9">201</span><span style="color:#24292E;--shiki-dark:#F8F8F2">, {}));</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">        }).</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">catch</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#D73A49;--shiki-dark:#FF79C6">function</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> (</span><span style="color:#E36209;--shiki-dark:#FFB86C;font-style:inherit;--shiki-dark-font-style:italic">error</span><span style="color:#24292E;--shiki-dark:#F8F8F2">) {</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">          console.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">log</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#032F62;--shiki-dark:#F1FA8C">ERROR></span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#24292E;--shiki-dark:#F8F8F2">, error);</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#50FA7B">          success</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">response</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#005CC5;--shiki-dark:#BD93F9">500</span><span style="color:#24292E;--shiki-dark:#F8F8F2">, { error</span><span style="color:#24292E;--shiki-dark:#FF79C6">:</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> error }));</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">        });</span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">    }, </span><span style="color:#005CC5;--shiki-dark:#BD93F9">1000</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> *</span><span style="color:#6F42C1;--shiki-dark:#50FA7B"> parseInt</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(delay));</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">  });</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">}</span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">function</span><span style="color:#6F42C1;--shiki-dark:#50FA7B"> decodeURLSearchParams</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#E36209;--shiki-dark:#FFB86C;font-style:inherit;--shiki-dark-font-style:italic">params</span><span style="color:#24292E;--shiki-dark:#F8F8F2">) {</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">  const</span><span style="color:#005CC5;--shiki-dark:#F8F8F2"> decodedParams</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> =</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> {};</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">  for</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> (</span><span style="color:#D73A49;--shiki-dark:#FF79C6">const</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> [</span><span style="color:#005CC5;--shiki-dark:#F8F8F2">key</span><span style="color:#24292E;--shiki-dark:#F8F8F2">, </span><span style="color:#005CC5;--shiki-dark:#F8F8F2">value</span><span style="color:#24292E;--shiki-dark:#F8F8F2">] </span><span style="color:#D73A49;--shiki-dark:#FF79C6">of</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> params) {</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">    decodedParams[key] </span><span style="color:#D73A49;--shiki-dark:#FF79C6">=</span><span style="color:#6F42C1;--shiki-dark:#50FA7B"> decodeURIComponent</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(value);</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">  }</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">  return</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> decodedParams;</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">}</span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">function</span><span style="color:#6F42C1;--shiki-dark:#50FA7B"> decodeForm</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#E36209;--shiki-dark:#FFB86C;font-style:inherit;--shiki-dark-font-style:italic">formData</span><span style="color:#24292E;--shiki-dark:#F8F8F2">) {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">    // Parse the form data</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">    const</span><span style="color:#005CC5;--shiki-dark:#F8F8F2"> decodedFormData</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> =</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> {};</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">    const</span><span style="color:#005CC5;--shiki-dark:#F8F8F2"> pairs</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> =</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> formData.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">split</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#032F62;--shiki-dark:#F1FA8C">&#x26;</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#24292E;--shiki-dark:#F8F8F2">);</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">    pairs.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">forEach</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#E36209;--shiki-dark:#FFB86C;font-style:inherit;--shiki-dark-font-style:italic">pair</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> =></span><span style="color:#24292E;--shiki-dark:#F8F8F2"> {</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">        const</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> [</span><span style="color:#005CC5;--shiki-dark:#F8F8F2">key</span><span style="color:#24292E;--shiki-dark:#F8F8F2">, </span><span style="color:#005CC5;--shiki-dark:#F8F8F2">value</span><span style="color:#24292E;--shiki-dark:#F8F8F2">] </span><span style="color:#D73A49;--shiki-dark:#FF79C6">=</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> pair.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">split</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#032F62;--shiki-dark:#F1FA8C">=</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#24292E;--shiki-dark:#F8F8F2">);</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">        const</span><span style="color:#005CC5;--shiki-dark:#F8F8F2"> decodedKey</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> =</span><span style="color:#6F42C1;--shiki-dark:#50FA7B"> decodeURIComponent</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(key);</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">        let</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> decodedValue;</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">        try</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">            // Try parsing the value as JSON</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">            decodedValue </span><span style="color:#D73A49;--shiki-dark:#FF79C6">=</span><span style="color:#005CC5;--shiki-dark:#BD93F9"> JSON</span><span style="color:#24292E;--shiki-dark:#F8F8F2">.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">parse</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">decodeURIComponent</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(value));</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">        } </span><span style="color:#D73A49;--shiki-dark:#FF79C6">catch</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> (error) {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">            // If parsing fails, assume regular URL-encoded value</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">            decodedValue </span><span style="color:#D73A49;--shiki-dark:#FF79C6">=</span><span style="color:#6F42C1;--shiki-dark:#50FA7B"> decodeURIComponent</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(value);</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">        }</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">        decodedFormData[decodedKey] </span><span style="color:#D73A49;--shiki-dark:#FF79C6">=</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> decodedValue;</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">    });</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">    return</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> decodedFormData;</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">}</span></span>
 <span class="line"></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#8BE9FD;font-style:inherit;--shiki-dark-font-style:italic">module</span><span style="color:#24292E;--shiki-dark:#F8F8F2">.</span><span style="color:#005CC5;--shiki-dark:#8BE9FD;font-style:inherit;--shiki-dark-font-style:italic">exports</span><span style="color:#24292E;--shiki-dark:#F8F8F2">.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">debugger</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> =</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> async</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> (</span><span style="color:#E36209;--shiki-dark:#FFB86C;font-style:inherit;--shiki-dark-font-style:italic">event</span><span style="color:#24292E;--shiki-dark:#F8F8F2">) </span><span style="color:#D73A49;--shiki-dark:#FF79C6">=></span><span style="color:#24292E;--shiki-dark:#F8F8F2"> {</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">  console.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">log</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#032F62;--shiki-dark:#F1FA8C">register event</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#24292E;--shiki-dark:#F8F8F2">, </span><span style="color:#005CC5;--shiki-dark:#BD93F9">JSON</span><span style="color:#24292E;--shiki-dark:#F8F8F2">.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">stringify</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(event, </span><span style="color:#005CC5;--shiki-dark:#BD93F9">null</span><span style="color:#24292E;--shiki-dark:#F8F8F2">, </span><span style="color:#005CC5;--shiki-dark:#BD93F9">2</span><span style="color:#24292E;--shiki-dark:#F8F8F2">));</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">  // const data = decodeForm(event.body);</span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">  const</span><span style="color:#005CC5;--shiki-dark:#F8F8F2"> data</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> =</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> querystring.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">parse</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(event.body);</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">  const</span><span style="color:#005CC5;--shiki-dark:#F8F8F2"> payloadData</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> =</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> typeof</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> (data.data) </span><span style="color:#D73A49;--shiki-dark:#FF79C6">===</span><span style="color:#032F62;--shiki-dark:#E9F284"> '</span><span style="color:#032F62;--shiki-dark:#F1FA8C">string</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> ?</span><span style="color:#005CC5;--shiki-dark:#BD93F9"> JSON</span><span style="color:#24292E;--shiki-dark:#F8F8F2">.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">parse</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(data.data) </span><span style="color:#D73A49;--shiki-dark:#FF79C6">:</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> data.data</span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">  const</span><span style="color:#005CC5;--shiki-dark:#F8F8F2"> payload</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> =</span><span style="color:#005CC5;--shiki-dark:#BD93F9"> JSON</span><span style="color:#24292E;--shiki-dark:#F8F8F2">.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">stringify</span><span style="color:#24292E;--shiki-dark:#F8F8F2">({</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">    title</span><span style="color:#24292E;--shiki-dark:#FF79C6">:</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> data.title,</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">    body</span><span style="color:#24292E;--shiki-dark:#FF79C6">:</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> data.body,</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">    data</span><span style="color:#24292E;--shiki-dark:#FF79C6">:</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> {</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">      ...</span><span style="color:#24292E;--shiki-dark:#F8F8F2">payloadData,</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">      debuggerTimestamp</span><span style="color:#24292E;--shiki-dark:#FF79C6">:</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> Date.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">now</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(),</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">    },</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">  })</span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">  const</span><span style="color:#005CC5;--shiki-dark:#F8F8F2"> options</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> =</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> {</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">    TTL</span><span style="color:#24292E;--shiki-dark:#FF79C6">:</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> data.ttl </span><span style="color:#D73A49;--shiki-dark:#FF79C6">|</span><span style="color:#005CC5;--shiki-dark:#BD93F9"> 5</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">  };</span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">  const</span><span style="color:#005CC5;--shiki-dark:#F8F8F2"> delay</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> =</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> (data.delay) </span><span style="color:#D73A49;--shiki-dark:#FF79C6">?</span><span style="color:#6F42C1;--shiki-dark:#50FA7B"> parseInt</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(data.delay, </span><span style="color:#005CC5;--shiki-dark:#BD93F9">10</span><span style="color:#24292E;--shiki-dark:#F8F8F2">) </span><span style="color:#D73A49;--shiki-dark:#FF79C6">:</span><span style="color:#005CC5;--shiki-dark:#BD93F9"> 1</span><span style="color:#24292E;--shiki-dark:#F8F8F2">;</span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">  const</span><span style="color:#005CC5;--shiki-dark:#F8F8F2"> subData</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> =</span><span style="color:#005CC5;--shiki-dark:#BD93F9"> JSON</span><span style="color:#24292E;--shiki-dark:#F8F8F2">.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">parse</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(data.subs)</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">  console.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">log</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#032F62;--shiki-dark:#F1FA8C">subData</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#24292E;--shiki-dark:#F8F8F2">, subData)</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">  return</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> await</span><span style="color:#6F42C1;--shiki-dark:#50FA7B"> send</span><span style="color:#24292E;--shiki-dark:#F8F8F2">([subData], payload, options, delay);</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">};</span></span>
 <span class="line"></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#8BE9FD;font-style:inherit;--shiki-dark-font-style:italic">module</span><span style="color:#24292E;--shiki-dark:#F8F8F2">.</span><span style="color:#005CC5;--shiki-dark:#8BE9FD;font-style:inherit;--shiki-dark-font-style:italic">exports</span><span style="color:#24292E;--shiki-dark:#F8F8F2">.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">sendNotification</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> =</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> async</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> (</span><span style="color:#E36209;--shiki-dark:#FFB86C;font-style:inherit;--shiki-dark-font-style:italic">event</span><span style="color:#24292E;--shiki-dark:#F8F8F2">) </span><span style="color:#D73A49;--shiki-dark:#FF79C6">=></span><span style="color:#24292E;--shiki-dark:#F8F8F2"> {</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">  console.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">log</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#032F62;--shiki-dark:#F1FA8C">register event</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#24292E;--shiki-dark:#F8F8F2">, </span><span style="color:#005CC5;--shiki-dark:#BD93F9">JSON</span><span style="color:#24292E;--shiki-dark:#F8F8F2">.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">stringify</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(event, </span><span style="color:#005CC5;--shiki-dark:#BD93F9">null</span><span style="color:#24292E;--shiki-dark:#F8F8F2">, </span><span style="color:#005CC5;--shiki-dark:#BD93F9">2</span><span style="color:#24292E;--shiki-dark:#F8F8F2">));</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">  let</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> body </span><span style="color:#D73A49;--shiki-dark:#FF79C6">=</span><span style="color:#005CC5;--shiki-dark:#BD93F9"> JSON</span><span style="color:#24292E;--shiki-dark:#F8F8F2">.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">parse</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(event.body);</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">  const</span><span style="color:#005CC5;--shiki-dark:#F8F8F2"> subscription</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> =</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> body.subscription;</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">  const</span><span style="color:#005CC5;--shiki-dark:#F8F8F2"> payload</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> =</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> body.payload;</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">  const</span><span style="color:#005CC5;--shiki-dark:#F8F8F2"> delay</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> =</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> body.delay;</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">  const</span><span style="color:#005CC5;--shiki-dark:#F8F8F2"> options</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> =</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> {</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">    TTL</span><span style="color:#24292E;--shiki-dark:#FF79C6">:</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> body.ttl </span><span style="color:#D73A49;--shiki-dark:#FF79C6">|</span><span style="color:#005CC5;--shiki-dark:#BD93F9"> 5</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">  };</span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">  return</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> await</span><span style="color:#6F42C1;--shiki-dark:#50FA7B"> send</span><span style="color:#24292E;--shiki-dark:#F8F8F2">([subscription], payload, options, delay);</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">};</span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">// module.exports.registerOrSendToAll = async (event) => {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   if (event.resource === '/register') {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     await addSubscription(JSON.parse(event.body).subscription);</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     return response(201, event);</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   } else {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     console.log('register event', JSON.stringify(event, null, 2));</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     let body = JSON.parse(event.body);</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     console.log('got body', body);</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     const payload = body.payload;</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     const delay = body.delay;</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     const options = {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//       TTL: body.ttl | 5</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     };</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     const subscriptions = await getSubscriptions();</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     return await send(subscriptions, payload, options, delay);</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   }</span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">// };</span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">// module.exports.notifyNewOrChanged = async (event) => {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   //console.log('Received event:', JSON.stringify(event));</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   let message = null;</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   for (let i = 0; i &lt; event.Records.length; i++) {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     const r = event.Records[i];</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     switch (r.EventSource) {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//       case 'aws:sns':</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//         message = JSON.parse(r.Sns.Message);</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//         if (message.hasOwnProperty("Records")) {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//           const r = message.Records;</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//           if (r.s3.object.key.startsWith('schedule')) {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//             console.log(r.s3.object.key);</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//           } else {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//             await handle_appw(r);</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//           }</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//         } else {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//           console.log('unrecognised SNS message',message);</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//         }</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//         break;</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//       default:</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//       	console.log('Received unknown event:', JSON.stringify(r));</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     }</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   }</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   return `Successfully processed ${event.Records.length} messages.`;</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">// };</span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">// async function handle_appw(message) {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   //console.log('handle_appw', JSON.stringify(message));</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   const path = message.s3.object.key.split("/");</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   let pid = null;</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   let entity_type = null;</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   let doc = null;</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   if (message.s3.bucket.name==='ws-partners-appw-merge-test') {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     entity_type = path[1];</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     pid = path[2].split('.')[1];</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     const r = await s3.getObject({ Bucket: message.s3.bucket.name, Key: message.s3.object.key }).promise();</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     doc = JSON.parse(r.Body.toString("utf-8"));</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   } else {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     entity_type = path[4];</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     pid = path[5].split('.')[1];</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     doc = await get_appw(message.s3.bucket.name, message.s3.object.key);</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   }</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   switch (entity_type) {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     case 'clip':</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     case 'episode':</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//       {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//         const entity = doc.pips[entity_type];</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//         //console.log(JSON.stringify(entity));</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//         if(entity.hasOwnProperty('languages')) {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//           const lang = entity.languages.language.$;</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//           if(lang===process.env.LANG) {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//             const payload = {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//               msg: `new or changed ${entity_type} ${pid}`,</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//               pid: pid,</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//               entity_type: entity_type,</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//               entity: entity</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//             };</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//             console.log(`new or changed ${entity_type} ${pid}`);</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//             const subscriptions = await getSubscriptions();</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//             await send(subscriptions, payload, { TTL: 5 }, 0);</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//           }</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//         }</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//       }</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//       break;</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">      </span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     case 'availability':      // safe to ignore, but should we even be getting them here?</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     case 'brand':</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     case 'series':</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//       break;</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">      </span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     default:</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//       console.log(JSON.stringify(doc));</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   }</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">// }</span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">// async function get_appw(bucket, key) {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   console.log('get_appw', bucket, key);</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   const appw = await sts</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     .assumeRole({</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//       RoleArn: process.env.APPW_ROLE,</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//       RoleSessionName: "dazzler-test"</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     })</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     .promise();</span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   const appwS3 = new aws.S3({</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     accessKeyId: appw.Credentials.AccessKeyId,</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     secretAccessKey: appw.Credentials.SecretAccessKey,</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     sessionToken: appw.Credentials.SessionToken</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   });</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   try {</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     const appw_doc = await appwS3</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//       .getObject({ Bucket: bucket, Key: key })</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//       .promise();</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     return JSON.parse(appw_doc.Body.toString("utf-8"));</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   }</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   catch(error) {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//     return null;</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">//   }</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">// }</span></span>
 <span class="line"></span>
 <span class="line"><span style="color:#005CC5;--shiki-dark:#8BE9FD;font-style:inherit;--shiki-dark-font-style:italic">module</span><span style="color:#24292E;--shiki-dark:#F8F8F2">.</span><span style="color:#005CC5;--shiki-dark:#8BE9FD;font-style:inherit;--shiki-dark-font-style:italic">exports</span><span style="color:#24292E;--shiki-dark:#F8F8F2">.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">statics</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> =</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> async</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> (</span><span style="color:#E36209;--shiki-dark:#FFB86C;font-style:inherit;--shiki-dark-font-style:italic">event</span><span style="color:#24292E;--shiki-dark:#F8F8F2">) </span><span style="color:#D73A49;--shiki-dark:#FF79C6">=></span><span style="color:#24292E;--shiki-dark:#F8F8F2"> {</span></span>
 <span class="line"><span style="color:#6A737D;--shiki-dark:#6272A4">  // Serve static files from lambda (only for simplicity of this example)</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">  var</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> file </span><span style="color:#D73A49;--shiki-dark:#FF79C6">=</span><span style="color:#24292E;--shiki-dark:#F8F8F2"> fs.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">readFileSync</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#032F62;--shiki-dark:#F1FA8C">`./static</span><span style="color:#032F62;--shiki-dark:#FF79C6">${</span><span style="color:#24292E;--shiki-dark:#F8F8F2">event</span><span style="color:#032F62;--shiki-dark:#F8F8F2">.</span><span style="color:#24292E;--shiki-dark:#F8F8F2">resource</span><span style="color:#032F62;--shiki-dark:#FF79C6">}</span><span style="color:#032F62;--shiki-dark:#F1FA8C">`</span><span style="color:#24292E;--shiki-dark:#F8F8F2">);</span></span>
 <span class="line"><span style="color:#D73A49;--shiki-dark:#FF79C6">  return</span><span style="color:#D73A49;--shiki-dark:#FF79C6"> await</span><span style="color:#6F42C1;--shiki-dark:#50FA7B"> response</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#005CC5;--shiki-dark:#BD93F9">200</span><span style="color:#24292E;--shiki-dark:#F8F8F2">, file.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">toString</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(), event.resource.</span><span style="color:#6F42C1;--shiki-dark:#50FA7B">split</span><span style="color:#24292E;--shiki-dark:#F8F8F2">(</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#032F62;--shiki-dark:#F1FA8C">/</span><span style="color:#032F62;--shiki-dark:#E9F284">'</span><span style="color:#24292E;--shiki-dark:#F8F8F2">)[</span><span style="color:#005CC5;--shiki-dark:#BD93F9">1</span><span style="color:#24292E;--shiki-dark:#F8F8F2">]);</span></span>
 <span class="line"><span style="color:#24292E;--shiki-dark:#F8F8F2">};</span></span></code></pre>
 <!-- end-doc-gen -->

 Infrastructure as code

 Productionizing

 In the demo we are utilizing dynamoDB and scan operations to fetch the list of subscriptions to send notifications to. This works okay to start out but eventually you may want to optimize this with a slightly different data model, especially if you have multiple different channels the users can subscribe to.

 Wrapping up

 Here is a link to the GitHub repo that includes the source code to this post.
