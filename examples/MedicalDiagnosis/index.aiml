---
name: MedicalDiagnosisAssistant
inputSchema:
  type: object
  properties:
    symptoms:
      type: array
      items:
        type: string
      description: List of symptoms the patient is experiencing
    duration:
      type: integer
      description: Duration of symptoms in days
    patientAge:
      type: integer
      description: Age of the patient in years
    patientGender:
      type: string
      enum: ["male", "female", "other"]
      description: Gender of the patient
    medicalHistory:
      type: array
      items:
        type: string
      description: Previous medical conditions
root: true
---

{/* 
This AIML file implements a medical diagnosis assistant that helps analyze patient symptoms
and medical history to provide potential diagnoses. It follows a structured workflow that
mimics clinical reasoning - gathering information, analyzing symptoms, generating potential
diagnoses, and providing recommendations.

The system is designed to be cautious and always emphasize that medical attention should be
sought for proper diagnosis. Each diagnostic possibility is rated by likelihood and includes
rationale for why it might match the patient's presentation.
*/}

import MedicalGuidelines from "./MedicalGuidelines.json"
import EmergencySymptoms from "./EmergencySymptoms.json"

<workflow initial="emergencyCheck">
  <datamodel>
    <data id="symptoms" type="array" schema={{
        type: "array",
        items: { type: "string" }
    }}>{ctx => ctx.workflowInput.symptoms}</data>
    <data id="duration" type="integer">{ctx => ctx.workflowInput.duration}</data>
    <data id="patientAge" type="integer">{ctx => ctx.workflowInput.patientAge}</data>
    <data id="patientGender" type="string">{ctx => ctx.workflowInput.patientGender}</data>
    <data id="medicalHistory" type="array" schema={{
        type: "array",
        items: { type: "string" }
    }}>{ctx => ctx.workflowInput.medicalHistory}</data>
    <data id="isEmergency" type="boolean" value={false} />
    <data id="emergencyReason" type="string" value={""} />
    <data id="symptomGroups" type="json" value={{}} schema={{
        type: "object",
        properties: {
          respiratory: { type: "array" },
          cardiovascular: { type: "array" },
          gastrointestinal: { type: "array" },
          neurological: { type: "array" },
          musculoskeletal: { type: "array" },
          dermatological: { type: "array" },
          general: { type: "array" }
        },
        required: ["respiratory", "cardiovascular", "gastrointestinal", "neurological", "musculoskeletal", "dermatological", "general"]
    }} />
    <data id="potentialDiagnoses" type="array" value={[]} schema={{
        type: "array",
        items: { type: "object", properties: {
          diagnosis: { type: "string" },
          likelihood: { type: "string" },
          explanation: { type: "string" },
          keySymptoms: { type: "array", items: { type: "string" } }
        },
        required: ["diagnosis", "likelihood", "explanation", "keySymptoms"]
    }} />
    <data id="diagnosticReasoning" type="string" value={""} />
    <data id="recommendations" type="array" value={[]} schema={{
        type: "array",
        items: { type: "object", properties: {
          type: { type: "string" },
          urgency: { type: "string" },
          recommendation: { type: "string" },
          rationale: { type: "string" }
        },
        required: ["type", "urgency", "recommendation", "rationale"]
    }} />
  </datamodel>

  <state id="emergencyCheck">
      <script>
        // Check if any symptoms match emergency symptoms
        const emergencySymptoms = JSON.parse(EmergencySymptoms);
        for (const symptom of ctx.datamodel.symptoms) {
          const matchedEmergency = emergencySymptoms.find(es => 
            symptom.toLowerCase().includes(es.keyword.toLowerCase())
          );
          
          if (matchedEmergency) {
            ctx.datamodel.isEmergency = true;
            ctx.datamodel.emergencyReason = matchedEmergency.reason;
            break;
          }
        }
        
        // Check age-related emergency conditions
        if (ctx.datamodel.patientAge < 2 && ctx.datamodel.duration > 2 && ctx.datamodel.symptoms.some(s => 
          s.toLowerCase().includes("fever") || 
          s.toLowerCase().includes("rash") || 
          s.toLowerCase().includes("not eating"))) {
          ctx.datamodel.isEmergency = true;
          ctx.datamodel.emergencyReason = "Infants under 2 years with persistent symptoms require immediate medical attention";
        }
        
        // Check for elderly with certain symptoms
        if (ctx.datamodel.patientAge > 65 && ctx.datamodel.symptoms.some(s => 
          s.toLowerCase().includes("confusion") || 
          s.toLowerCase().includes("severe pain") || 
          s.toLowerCase().includes("shortness of breath"))) {
          ctx.datamodel.isEmergency = true;
          ctx.datamodel.emergencyReason = "Elderly patients with these symptoms should seek immediate medical care";
        }
      </script>
      <log value={(ctx) => 'Emergency check completed: ' + (ctx.datamodel.isEmergency ? 'YES - ' + ctx.datamodel.emergencyReason : 'No')} />
    
      <transition cond={(ctx) => ctx.datamodel.isEmergency} target="emergencyResponse" />
      <transition target="symptomAnalysis" />
  </state>

  <final id="emergencyResponse">
      <sendText>
        ⚠️ EMERGENCY WARNING ⚠️
        
        Based on the information provided, this appears to be a medical emergency requiring IMMEDIATE medical attention.
        
        Reason: {ctx.datamodel.emergencyReason}
        
        Please contact emergency services (911, 999, 112, etc.) immediately or go to the nearest emergency room.
        Do NOT wait for symptoms to worsen.
        
        This is an automated assessment and is not a substitute for professional medical advice.
      </sendText>
  </final>

  <state id="symptomAnalysis">
      <script>
        // Group symptoms by body system
        const bodySystems = {
          respiratory: ["cough", "shortness of breath", "wheezing", "sore throat", "congestion"],
          cardiovascular: ["chest pain", "palpitations", "high blood pressure", "swelling"],
          gastrointestinal: ["nausea", "vomiting", "diarrhea", "constipation", "abdominal pain"],
          neurological: ["headache", "dizziness", "confusion", "numbness", "tingling"],
          musculoskeletal: ["joint pain", "muscle pain", "weakness", "stiffness", "back pain"],
          dermatological: ["rash", "itching", "hives", "skin lesion", "discoloration"],
          general: ["fever", "fatigue", "weight loss", "weight gain", "night sweats"]
        };
        
        ctx.datamodel.symptomGroups = {};
        for (const [system, keywords] of Object.entries(bodySystems)) {
          const matchedSymptoms = ctx.datamodel.symptoms.filter(symptom => 
            keywords.some(keyword => symptom.toLowerCase().includes(keyword))
          );
          
          if (matchedSymptoms.length > 0) {
            ctx.datamodel.symptomGroups[system] = matchedSymptoms;
          }
        }
        
        // Assign any unmatched symptoms to "other"
        const allGroupedSymptoms = Object.values(ctx.datamodel.symptomGroups).flat();
        const ungroupedSymptoms = ctx.datamodel.symptoms.filter(symptom => 
          !allGroupedSymptoms.includes(symptom)
        );
        
        if (ungroupedSymptoms.length > 0) {
          ctx.datamodel.symptomGroups.other = ungroupedSymptoms;
        }
      </script>
      <log value={(ctx) => 'Symptom analysis complete. Identified ' + Object.keys(ctx.datamodel.symptomGroups).length + ' affected body systems'} />
      <transition target="generateDiagnoses" />
  </state>

  <state id="generateDiagnoses">
      <llm model="gpt-4o" temperature={0.3}>
        <prompt>
          You are an AI medical diagnostic assistant. Based on the following patient information, 
          generate potential diagnoses with likelihood ratings and explanations. Be thorough but 
          conservative, and always emphasize that a healthcare professional must make the actual diagnosis.
          
          Patient Information:
          - Age: {ctx.datamodel.patientAge}
          - Gender: {ctx.datamodel.patientGender}
          - Symptom Duration: {ctx.datamodel.duration} days
          - Medical History: {ctx.datamodel.medicalHistory.join(", ") || "None reported"}
          
          Symptoms by body system:
          {Object.entries(ctx.datamodel.symptomGroups).map(([system, symptoms]) => 
            `- ${system.charAt(0).toUpperCase() + system.slice(1)}: ${symptoms.join(", ")}`
          ).join("\n")}
          
          Provide a minimum of 3 and maximum of 5 potential diagnoses in JSON format:
          [
            {
              "diagnosis": "Name of condition",
              "likelihood": "high|medium|low",
              "explanation": "Why this might match the presentation",
              "keySymptoms": ["matching symptom 1", "matching symptom 2"]
            }
          ]
          
          Order diagnoses from most to least likely. Include common conditions as well as more serious 
          possibilities that should not be missed. Consider age, gender, and duration in your assessment.
        </prompt>
      </llm>
      <script>
        try {
          ctx.datamodel.potentialDiagnoses = JSON.parse(ctx.lastElement.output);
          
          // Validate structure
          if (!Array.isArray(ctx.datamodel.potentialDiagnoses)) {
            throw new Error("Diagnoses not in array format");
          }
          
          // Ensure we have at least one diagnosis
          if (ctx.datamodel.potentialDiagnoses.length === 0) {
            throw new Error("No diagnoses generated");
          }
        } catch (e) {
          ctx.log("Error parsing diagnoses: " + e.message);
          // Create a fallback diagnosis
          ctx.datamodel.potentialDiagnoses = [
            {
              diagnosis: "Insufficient information for accurate assessment",
              likelihood: "medium",
              explanation: "The symptoms provided are too general or may match many conditions. A healthcare provider should evaluate the patient.",
              keySymptoms: ctx.datamodel.symptoms
            }
          ];
        }
      </script>
      <transition target="generateReasoning" />
  </state>

  <state id="generateReasoning">
      <llm model="gpt-4o" temperature={0.2}>
        <prompt>
          Generate a clinical reasoning explanation based on this patient's presentation.
          Explain how the symptoms, history, and patient factors point to the potential diagnoses.
          This should be a professional explanation of the diagnostic thought process.
          
          Patient Information:
          - Age: {ctx.datamodel.patientAge}
          - Gender: {ctx.datamodel.patientGender}
          - Symptom Duration: {ctx.datamodel.duration} days
          - Medical History: {ctx.datamodel.medicalHistory.join(", ") || "None reported"}
          
          Symptoms by body system:
          {Object.entries(ctx.datamodel.symptomGroups).map(([system, symptoms]) => 
            `- ${system.charAt(0).toUpperCase() + system.slice(1)}: ${symptoms.join(", ")}`
          ).join("\n")}
          
          Potential Diagnoses:
          {ctx.datamodel.potentialDiagnoses.map(d => 
            `- ${d.diagnosis} (${d.likelihood} likelihood): ${d.explanation}`
          ).join("\n")}
          
          Provide a structured clinical reasoning analysis that:
          1. Identifies patterns in the symptoms
          2. Explains why certain diagnoses were prioritized
          3. Discusses how patient factors influence the assessment
          4. Mentions what additional information would be helpful
          
          Keep the explanation concise (200-300 words) but medically accurate and educational.
        </prompt>
      </llm>
      <assign location="diagnosticReasoning" value={(ctx) => ctx.lastElement.output} />
      <transition target="generateRecommendations" />
  </state>

  <state id="generateRecommendations">
      <llm model="gpt-4o" temperature={0.2}>
        <prompt>
          Based on the patient information and possible diagnoses, generate clinical recommendations.
          These should be practical next steps for the patient, emphasizing when medical attention is needed.
          
          Patient Information:
          - Age: {ctx.datamodel.patientAge}
          - Gender: {ctx.datamodel.patientGender}
          - Symptom Duration: {ctx.datamodel.duration} days
          
          Potential Diagnoses:
          {ctx.datamodel.potentialDiagnoses.map(d => 
            `- ${d.diagnosis} (${d.likelihood} likelihood)`
          ).join("\n")}
          
          Provide recommendations in JSON format:
          [
            {
              "type": "medical_attention|testing|home_care|monitoring|medication|lifestyle",
              "urgency": "immediate|urgent|soon|routine",
              "recommendation": "Clear description of the recommendation",
              "rationale": "Brief explanation of why this is recommended"
            }
          ]
          
          Include at least one recommendation from each of these categories:
          1. Whether and when to seek medical attention
          2. Tests or examinations that might be helpful
          3. Home care measures that might relieve symptoms
          4. Warning signs that would require immediate medical attention
          
          Recommendations should be aligned with standard medical guidelines.
        </prompt>
      </llm>
      <script>
        try {
          ctx.datamodel.recommendations = JSON.parse(ctx.lastElement.output);
          
          // Validate structure
          if (!Array.isArray(ctx.datamodel.recommendations)) {
            throw new Error("Recommendations not in array format");
          }
          
          // Sort by urgency
          const urgencyOrder = { 'immediate': 0, 'urgent': 1, 'soon': 2, 'routine': 3 };
          ctx.datamodel.recommendations.sort((a, b) => 
            urgencyOrder[a.urgency] - urgencyOrder[b.urgency]
          );
        } catch (e) {
          ctx.log("Error parsing recommendations: " + e.message);
          // Create fallback recommendations
          ctx.datamodel.recommendations = [
            {
              type: "medical_attention",
              urgency: "soon",
              recommendation: "Consult with a healthcare provider",
              rationale: "A proper medical evaluation is needed for accurate diagnosis"
            },
            {
              type: "monitoring",
              urgency: "routine",
              recommendation: "Monitor symptoms and note any changes",
              rationale: "Changes in symptoms can help with diagnosis"
            }
          ];
        }
      </script>
      <transition target="presentResults" />
  </state>

  <final id="presentResults" final="true">
      <sendObject value={ctx => (
        {
          "diagnoses": ctx.datamodel.potentialDiagnoses,
          "reasoning": ctx.datamodel.diagnosticReasoning,
          "recommendations": ctx.datamodel.recommendations,
          "disclaimer": "This analysis is for informational purposes only and does not constitute medical advice. Always consult with a qualified healthcare provider for proper diagnosis and treatment."
        }
      )} />
  </final>
</workflow>